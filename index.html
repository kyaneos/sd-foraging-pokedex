<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foraging Pokedex</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* --- Base Styles & Color Palette --- */
        :root {
            /* Pokedex Device Colors */
            --pokedex-case-color: #212529;
            --pokedex-screen-bg: #1a263a;
            --pokedex-screen-border: #3a506b;
            --pokedex-list-bg: #24344d;
            --pokedex-text-main: #ced4da;
            --pokedex-text-heading: #f8f9fa;
            --pokedex-text-secondary: #adb5bd;
            --pokedex-accent: #00b4d8;
            --pokedex-selected-bg: rgba(0, 180, 216, 0.1);
            --pokedex-selected-border: var(--pokedex-accent);
            --pokedex-hover-bg: rgba(255, 255, 255, 0.05);
            --pokedex-button-bg: #495057;
            --pokedex-button-text: #ffffff;
            --pokedex-button-hover-bg: #5a6268;
            --pokedex-button-active-bg: #343a40;
            --pokedex-led-red: #e63946;
            --pokedex-led-yellow: #ffbe0b;
            --pokedex-led-green: #52b788;

            --disclaimer-bg: rgba(255, 235, 238, 0.05);
            --disclaimer-text: #ffcdd2;
            --disclaimer-border: rgba(255, 205, 210, 0.2);

            /* Modal colors */
            --modal-bg: rgba(10, 25, 41, 0.95); /* Dark semi-transparent */
            --modal-content-bg: #2b3a4f;
            --modal-border: var(--pokedex-screen-border);
            --modal-text: var(--pokedex-text-main);
            --modal-heading: var(--pokedex-text-heading);
            --modal-link: var(--pokedex-accent);

            --font-sans: 'Inter', sans-serif;
            --font-pixel: 'Press Start 2P', cursive;

            --spacing-unit: 8px;
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --transition-speed-fast: 0.1s;
            --transition-speed-med: 0.2s;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
            --shadow-inset: inset 0 2px 5px rgba(0,0,0,0.5);
            --shadow-inset-light: inset 0 1px 2px rgba(0,0,0,0.3);
            --shadow-text: 0 1px 1px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(to bottom, #343a40, #111);
            padding: calc(var(--spacing-unit) * 2);
            color: var(--pokedex-text-main);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; overflow: hidden;
        }

        /* --- Pokedex Device Container --- */
        .pokedex-device {
            width: 100%; max-width: 1000px; height: 700px; max-height: 90vh;
            background: linear-gradient(145deg, #2f343a, #1a1d20);
            border-radius: var(--border-radius-lg);
            border: 4px solid #0a0a0a;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6), inset 0 4px 6px rgba(255,255,255,0.06);
            padding: calc(var(--spacing-unit) * 3);
            display: flex; flex-direction: column; position: relative;
        }

        /* --- Decorative Elements --- */
        .pokedex-leds {
            position: absolute; top: calc(var(--spacing-unit) * 1.5); left: calc(var(--spacing-unit) * 3);
            display: flex; gap: var(--spacing-unit); z-index: 5;
        }
        .led {
            width: 12px; height: 12px; border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.7);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.1);
            animation: pulse-led 5s infinite ease-in-out;
        }
        .led.red { background: radial-gradient(circle at 30% 30%, #f88, var(--pokedex-led-red)); animation-delay: 0s; }
        .led.yellow { background: radial-gradient(circle at 30% 30%, #ffe57a, var(--pokedex-led-yellow)); animation-delay: 0.3s; }
        .led.green { background: radial-gradient(circle at 30% 30%, #a0f0c0, var(--pokedex-led-green)); animation-delay: 0.6s; }

        @keyframes pulse-led {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

         /* Info Button Styling */
        .info-button {
            position: absolute;
            top: calc(var(--spacing-unit) * 1.5);
            right: calc(var(--spacing-unit) * 3);
            background-color: var(--pokedex-button-bg);
            color: var(--pokedex-button-text);
            border: 1px solid #111;
            border-radius: 50%; /* Make it circular */
            width: 28px; /* Adjust size */
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
            transition: background-color var(--transition-speed-fast) ease-out, transform var(--transition-speed-fast) ease-out;
        }
        .info-button:hover {
            background-color: var(--pokedex-button-hover-bg);
            transform: scale(1.1);
        }
        .info-button i {
            font-size: 0.9rem;
        }


        /* --- Pokedex Screen Area --- */
        .pokedex-screen {
            flex-grow: 1;
            background-color: var(--pokedex-screen-bg);
            border: 4px solid #222;
            border-top-color: #444; border-left-color: #444;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-inset);
            margin-top: calc(var(--spacing-unit) * 3);
            margin-bottom: calc(var(--spacing-unit) * 2);
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
        }
        /* Noise Texture Overlay */
        .pokedex-screen::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%23ffffff' fill-opacity='0.015' d='M1 3h1v1H1V3zm2-2h1v1H3V1z'%3E%3C/path%3E%3C/svg%3E");
            pointer-events: none; z-index: 1;
        }
        /* Loading Indicator */
        .pokedex-screen.loading::after {
            content: "LOADING..."; position: absolute; bottom: 10px; right: 15px;
            font-family: var(--font-pixel); font-size: 0.7rem;
            color: var(--pokedex-accent); opacity: 0.8; z-index: 15;
            animation: blink-loading 1s infinite;
        }
        @keyframes blink-loading { 50% { opacity: 0.3; } }

        /* --- Panels within Screen --- */
        .plant-list {
            order: 1; flex-basis: 100%;
            background-color: var(--pokedex-list-bg);
            overflow-y: auto; padding: calc(var(--spacing-unit) * 1.5);
            border-bottom: 2px solid var(--pokedex-screen-border);
            height: 45%; position: relative; z-index: 2;
        }

        .plant-detail {
            order: 2; flex-basis: 100%;
            padding: calc(var(--spacing-unit) * 2.5);
            display: flex; flex-direction: column; overflow-y: auto;
            height: 55%; position: relative;
            background-color: var(--pokedex-screen-bg); z-index: 2;
        }

        /* Detail Content Wrapper for Transitions */
        .plant-detail-content {
            opacity: 1; transform: translateX(0);
            transition: opacity var(--transition-speed-med) ease-out,
                        transform var(--transition-speed-med) ease-out;
        }
        .plant-detail-content.fade-out {
            opacity: 0; transform: translateX(-15px);
            position: absolute;
            top: calc(var(--spacing-unit) * 2.5); left: calc(var(--spacing-unit) * 2.5);
            right: calc(var(--spacing-unit) * 2.5); bottom: calc(var(--spacing-unit) * 2.5);
            pointer-events: none; /* Prevent interaction during fade */
        }


        /* --- List Item Styling --- */
        .plant-item {
            display: flex; align-items: center;
            padding: calc(var(--spacing-unit)*0.75) calc(var(--spacing-unit) * 1.5);
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            background-color: transparent;
            border-radius: var(--border-radius-sm); cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease-out,
                        border-color var(--transition-speed-fast) ease-out,
                        color var(--transition-speed-fast) ease-out;
            border: 1px solid transparent;
            color: var(--pokedex-text-secondary); font-size: 0.85rem; position: relative;
        }
        .plant-item::after { /* Indicator bar */
            content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 3px; height: 0%; background-color: var(--pokedex-accent);
            border-radius: 0 2px 2px 0; opacity: 0;
            transition: height var(--transition-speed-fast) ease-out, opacity var(--transition-speed-fast) ease-out,
                        box-shadow var(--transition-speed-fast) ease-out;
        }
        .plant-item:hover {
            background-color: var(--pokedex-hover-bg);
            color: var(--pokedex-text-main);
        }
        .plant-item:hover::after { opacity: 0.7; height: 70%; }
        .plant-item.selected {
            background-color: var(--pokedex-selected-bg);
            border-color: var(--pokedex-selected-border);
            color: var(--pokedex-text-heading); font-weight: 600;
        }
         .plant-item.selected::after {
             opacity: 1; height: 90%;
             box-shadow: 0 0 8px var(--pokedex-accent);
         }

        /* Icon Container */
        .plant-item .icon-container {
            width: 32px; height: 32px; flex-shrink: 0;
            margin-right: var(--spacing-unit);
            border: 1px solid var(--pokedex-screen-border); border-radius: 50%;
            background-color: var(--pokedex-screen-bg);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
             transition: border-color var(--transition-speed-fast) ease-out,
                         box-shadow var(--transition-speed-fast) ease-out;
             box-shadow: var(--shadow-inset-light);
        }
         .plant-item:hover .icon-container { border-color: var(--pokedex-text-secondary); }
         .plant-item.selected .icon-container {
             border-color: var(--pokedex-accent);
             box-shadow: 0 0 6px rgba(0, 180, 216, 0.6);
         }

        /* Pixel Art SVG */
        .plant-item .pixel-art-icon {
            width: 80%; height: 80%; display: block;
            image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
        }

        /* Text within List Item */
        .plant-item .plant-info { display: flex; flex-direction: column; overflow: hidden; }
        .plant-item .plant-number { font-size: 0.65rem; color: var(--pokedex-text-secondary); line-height: 1.2; }
         .plant-item .plant-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; line-height: 1.3; }
         .plant-item.selected .plant-name { font-weight: 600; }

        /* --- Detail Panel Styling --- */

        /* Detail Header */
        .plant-header {
             font-family: var(--font-sans); font-size: 1.6rem; font-weight: 700;
             color: var(--pokedex-text-heading); text-shadow: var(--shadow-text);
             margin-bottom: calc(var(--spacing-unit) * 2);
             padding-bottom: calc(var(--spacing-unit) * 1.5);
             border-bottom: 1px solid var(--pokedex-screen-border);
             display: flex; justify-content: space-between; align-items: flex-end;
             flex-wrap: wrap; gap: var(--spacing-unit);
        }
         .plant-header .number {
            font-family: var(--font-pixel); font-size: 0.8rem;
            color: var(--pokedex-text-secondary); background-color: var(--pokedex-list-bg);
            padding: calc(var(--spacing-unit)*0.5) var(--spacing-unit);
            border-radius: var(--border-radius-sm); border: 1px solid var(--pokedex-screen-border);
            white-space: nowrap; box-shadow: var(--shadow-inset-light);
         }

        /* Core Info Section */
        .plant-core-info { /* Same */ }

        /* Image Section */
        .plant-image-section {
            background-color: var(--pokedex-list-bg);
            border: 1px solid var(--pokedex-screen-border);
            box-shadow: var(--shadow-inset);
            transition: transform var(--transition-speed-med) ease-out;
            padding: var(--spacing-unit);
            border-radius: var(--border-radius-sm); /* Consistent radius */
            display: flex; /* Needed for centering */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            min-height: 200px; /* Ensure minimum height */
        }
        .plant-image-section img {
             border-radius: var(--border-radius-sm); box-shadow: none; border: none;
             max-height: 280px;
             display: block; /* Needed for centering */
             max-width: 100%;
             height: auto; /* Maintain aspect ratio */
             object-fit: cover;
        }

        /* Attributes Section (Desc, ID) */
        .plant-attributes { /* Same */ }

        /* General Section Styling (Desc, ID, Native Use, Stats) */
        .attribute-section, .stats-section {
             background-color: transparent; margin-bottom: calc(var(--spacing-unit) * 2);
             padding: 0; border: none; border-radius: 0; box-shadow: none;
        }

         .attribute-section h3, .stats-section h3 {
            font-family: var(--font-sans); font-weight: 700; font-size: 1rem;
            color: var(--pokedex-accent); text-shadow: var(--shadow-text);
            margin-bottom: calc(var(--spacing-unit)*0.75);
            padding-bottom: calc(var(--spacing-unit) * 0.5);
            border-bottom: 1px solid var(--pokedex-screen-border);
            display: inline-block; margin-top: 0;
         }

         .attribute-section p {
            font-size: 0.9rem; line-height: 1.6; color: var(--pokedex-text-main);
         }

        /* Stats Section Styling */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--spacing-unit); margin-top: var(--spacing-unit);
        }
        .stat-item {
            background: linear-gradient(to bottom, #3a4a5f, var(--pokedex-list-bg));
            padding: calc(var(--spacing-unit)*0.75) var(--spacing-unit);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--pokedex-screen-border);
            text-align: center; box-shadow: var(--shadow-inset-light);
        }
        .stat-item .label {
            font-size: 0.6rem; font-weight: 500; color: var(--pokedex-text-secondary);
            text-transform: uppercase; display: block; margin-bottom: 2px;
        }
        .stat-item .value {
            font-size: 0.85rem; font-weight: 600; color: var(--pokedex-text-main); display: block;
            text-shadow: var(--shadow-text);
        }
        /* Stat value colors */
        .stat-item .value[data-value="Abundant"], .stat-item .value[data-value="Easy"], .stat-item .value[data-value="High"] { color: var(--pokedex-led-green); }
        .stat-item .value[data-value="Common"], .stat-item .value[data-value="Medium"], .stat-item .value[data-value="Good"] { color: var(--pokedex-accent); }
        .stat-item .value[data-value="Uncommon"], .stat-item .value[data-value="Hard"] { color: var(--pokedex-led-yellow); }
        .stat-item .value[data-value="Rare"], .stat-item .value[data-value="Expert"], .stat-item .value[data-value="Caution"], .stat-item .value[data-value="Requires Prep"] { color: var(--pokedex-led-red); }

        /* Disclaimer Styling */
        .disclaimer {
            background-color: var(--disclaimer-bg); color: var(--disclaimer-text);
            padding: var(--spacing-unit); border-radius: var(--border-radius-sm);
            margin-top: calc(var(--spacing-unit) * 2); font-size: 0.7rem;
            border: 1px solid var(--disclaimer-border); line-height: 1.4;
            opacity: 0.7;
        }
         .disclaimer strong { font-weight: 600; color: var(--disclaimer-text); }

        /* --- Pokedex Controls Area --- */
        .pokedex-controls {
            display: flex; justify-content: space-between; align-items: center;
            padding-top: calc(var(--spacing-unit) * 2);
        }
        .nav-button {
            background: linear-gradient(to bottom, #5a6168, var(--pokedex-button-bg));
            color: var(--pokedex-button-text); border: 1px solid #111;
            padding: calc(var(--spacing-unit)*0.75) calc(var(--spacing-unit)*1.5);
            border-radius: var(--border-radius-md);
            font-family: var(--font-pixel); font-size: 0.65rem; letter-spacing: 0.5px;
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease-out, transform var(--transition-speed-fast) ease-out, box-shadow var(--transition-speed-fast) ease-out;
            display: inline-flex; align-items: center; gap: var(--spacing-unit);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
            text-shadow: 0 -1px 0 rgba(0,0,0,0.4);
        }
        .nav-button:hover:not(:disabled) {
            background-color: var(--pokedex-button-hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.35), inset 0 1px 1px rgba(255,255,255,0.1);
        }
        .nav-button:active:not(:disabled) {
            transform: translateY(1px);
            background: var(--pokedex-button-active-bg);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .nav-button:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: var(--shadow-sm); }
        .nav-button i { font-size: 1.1em; }

        /* Developer Credits */
        .dev-credits {
            position: absolute; bottom: calc(var(--spacing-unit) * 1); right: calc(var(--spacing-unit) * 3);
            font-size: 0.6rem; color: var(--pokedex-text-secondary);
            opacity: 0.5; z-index: 0;
        }

        /* Log On Screen Styling */
        .log-on-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #000; z-index: 100;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            opacity: 0; /* Start hidden */
            visibility: hidden; /* Start hidden */
            transition: opacity 0.5s 0.2s ease-out, visibility 0s 0.7s; /* Delay visibility transition */
            pointer-events: none;
        }
        .log-on-screen.visible { /* Class to make it visible */
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease-in, visibility 0s 0s;
            pointer-events: auto;
        }
        .log-on-screen.hidden { /* Class to fade out */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .log-on-text {
            font-family: var(--font-pixel); font-size: 1.2rem; color: var(--pokedex-accent);
            text-shadow: 0 0 5px var(--pokedex-accent); margin-bottom: 20px; opacity: 0;
            /* Animation controlled by JS */
        }
        .log-on-bar {
            width: 60%; max-width: 300px; height: 8px; background-color: var(--pokedex-screen-border);
            border-radius: 4px; overflow: hidden; opacity: 0;
             /* Animation controlled by JS */
        }
        .log-on-progress {
            width: 0%; height: 100%; background-color: var(--pokedex-accent);
            border-radius: 4px;
            /* Animation controlled by JS */
        }
        /* Use classes for log on animations */
        .log-on-text.animate { animation: fade-in-text 1s 0.5s forwards; }
        .log-on-bar.animate { animation: fade-in-bar 0.5s 1.5s forwards; }
        .log-on-progress.animate { animation: load-progress 1.5s 2s ease-out forwards; }


        @keyframes fade-in-text { to { opacity: 1; } }
        @keyframes fade-in-bar { to { opacity: 1; } }
        @keyframes load-progress { to { width: 100%; } }

        /* Start Screen Styling */
        .start-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #000; z-index: 110; /* Above log-on */
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 1;
            transition: opacity 0.4s ease-out;
        }
        .start-screen.hidden { opacity: 0; pointer-events: none; }
        .start-screen-text {
            font-family: var(--font-pixel); font-size: 1rem;
            color: var(--pokedex-accent); /* Use accent color */
            text-shadow: 0 0 8px var(--pokedex-accent);
            animation: blink-start 1.5s infinite ease-in-out;
        }
        @keyframes blink-start { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Info Modal Styling */
        .info-modal-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); z-index: 120;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0s 0.3s;
        }
        .info-modal-overlay.visible {
            opacity: 1; visibility: visible; transition: opacity 0.3s ease-in, visibility 0s 0s;
        }
        .info-modal {
            background-color: var(--modal-content-bg); color: var(--modal-text);
            padding: calc(var(--spacing-unit) * 3); border-radius: var(--border-radius-md);
            border: 2px solid var(--modal-border); max-width: 500px; width: 90%;
            max-height: 80vh; overflow-y: auto; position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .info-modal-overlay.visible .info-modal { transform: scale(1); }
        .info-modal h2 {
            font-family: var(--font-pixel); font-size: 1rem; color: var(--modal-heading);
            margin-bottom: calc(var(--spacing-unit) * 2); border-bottom: 1px solid var(--modal-border);
            padding-bottom: var(--spacing-unit);
        }
        .info-modal h3 {
            font-weight: 600; color: var(--pokedex-accent);
            margin-top: calc(var(--spacing-unit) * 2); margin-bottom: var(--spacing-unit);
            font-size: 0.9rem;
        }
        .info-modal p, .info-modal li {
            font-size: 0.85rem; line-height: 1.5; margin-bottom: calc(var(--spacing-unit)*0.5);
        }
        .info-modal ul { list-style: none; padding-left: 0; } /* Changed list style */
        .info-modal li { margin-bottom: calc(var(--spacing-unit)*1.5); } /* Spacing between refs */
        .info-modal a {
            color: var(--modal-link); text-decoration: none; display: block; /* Make links block */
            word-break: break-all; /* Break long URLs */
        }
        .info-modal a:hover { text-decoration: underline; }
        .info-modal strong { /* Style plant names in refs */
            color: var(--pokedex-text-heading);
            display: block;
            margin-bottom: calc(var(--spacing-unit)*0.5);
        }
        .close-modal-button {
            position: absolute; top: calc(var(--spacing-unit) * 1); right: calc(var(--spacing-unit) * 1);
            background: none; border: none; color: var(--pokedex-text-secondary);
            font-size: 1.5rem; cursor: pointer; padding: var(--spacing-unit);
            line-height: 1; transition: color var(--transition-speed-fast) ease-out;
        }
        .close-modal-button:hover { color: var(--pokedex-text-main); }


        /* --- Desktop Layout Adjustments (min-width: 768px) --- */
        @media (min-width: 768px) {
            .pokedex-screen { flex-direction: row; margin-top: calc(var(--spacing-unit) * 4); }
            .plant-list {
                order: 1; flex-basis: 35%; max-height: 100%; height: 100%;
                padding: calc(var(--spacing-unit) * 2);
                border-right: 2px solid var(--pokedex-screen-border); border-bottom: none;
            }
             .plant-detail {
                order: 2; flex-basis: 65%; max-height: 100%; height: 100%;
                padding: calc(var(--spacing-unit) * 3); border-bottom: none;
            }
            .plant-detail-content.fade-out {
                top: calc(var(--spacing-unit) * 3); left: calc(var(--spacing-unit) * 3);
                right: calc(var(--spacing-unit) * 3); bottom: calc(var(--spacing-unit) * 3);
            }
            .plant-header { font-size: 1.8rem; }
             .plant-header .number { font-size: 0.9rem; }
            .plant-core-info { flex-direction: row; align-items: flex-start; }
             .attribute-section h3, .stats-section h3 { font-size: 1.1rem; }
             .attribute-section p { font-size: 0.95rem; }
             .disclaimer { font-size: 0.8rem; }
             .plant-item .plant-name { white-space: normal; }
             .plant-item::after { left: 0; width: 3px; }
        }

         /* --- Larger Desktop Adjustments (min-width: 1200px) --- */
         @media (min-width: 1200px) {
             .plant-list { flex-basis: 30%; }
             .plant-detail { flex-basis: 70%; padding: calc(var(--spacing-unit) * 4); }
             .plant-header { font-size: 2rem; }
         }

         /* Custom Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--pokedex-list-bg); border-radius: 0; }
        ::-webkit-scrollbar-thumb { background-color: var(--pokedex-screen-border); border-radius: 0; border: 2px solid var(--pokedex-list-bg); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--pokedex-text-secondary); }

    </style>
</head>
<body>

    <div class="pokedex-device">
        <div class="info-modal-overlay" id="infoModalOverlay">
            <div class="info-modal">
                <button class="close-modal-button" id="closeModalButton">&times;</button>
                <h2>About / References</h2>
                <h3>Developer</h3>
                <p>Created by Justin Moran</p>

                <h3>Plant Information References</h3>
                 <ul>
                    <li>
                        <strong>California Buckwheat:</strong>
                        <a href="https://en.wikipedia.org/wiki/Eriogonum_fasciculatum" target="_blank" rel="noopener noreferrer">Wikipedia</a> |
                        <a href="https://plants.usda.gov/DocumentLibrary/plantguide/pdf/pg_erfa2.pdf" target="_blank" rel="noopener noreferrer">USDA Plant Guide</a>
                    </li>
                     <li>
                        <strong>Lemonade Berry:</strong>
                        <a href="https://www.baronamuseum.com/201619" target="_blank" rel="noopener noreferrer">Barona Museum</a> |
                        <a href="https://hiddensandiego.com/lemonade-berry.php" target="_blank" rel="noopener noreferrer">Hidden San Diego</a>
                    </li>
                     <li>
                        <strong>California Coffeeberry:</strong>
                        <a href="https://www.sandiego.edu/kumeyaay-garden/plant.php?ID=25" target="_blank" rel="noopener noreferrer">USD Kumeyaay Garden</a> |
                        <a href="https://www.grassrootsecology.org/from-the-field/2023/10/9/native-plant-of-the-month-coffeeberry" target="_blank" rel="noopener noreferrer">Grassroots Ecology</a>
                    </li>
                    <li>
                        <strong>Toyon:</strong>
                         <a href="https://www.sandiego.edu/kumeyaay-garden/plant.php?ID=23" target="_blank" rel="noopener noreferrer">USD Kumeyaay Garden</a> |
                         <a href="https://www.botgard.ucla.edu/toyon-preserves-recipe/" target="_blank" rel="noopener noreferrer">UCLA Botanical Garden</a>
                    </li>
                     <li>
                        <strong>Prickly Pear:</strong>
                        <a href="https://aihd.ku.edu/foods/prickly_pear_cactus.html" target="_blank" rel="noopener noreferrer">KU AIHD</a> |
                        <a href="https://www.pbssocal.org/shows/tending-the-wild/a-guide-to-some-indigenous-foods-of-california" target="_blank" rel="noopener noreferrer">PBS SoCal</a>
                    </li>
                     <li>
                        <strong>Miner's Lettuce:</strong>
                        <a href="https://ucanr.edu/blogs/blogcore/postdetail.cfm?postnum=16972" target="_blank" rel="noopener noreferrer">UCANR Blog</a> |
                        <a href="https://specialtyproduce.com/produce/Miners_Lettuce_5099.php" target="_blank" rel="noopener noreferrer">Specialty Produce</a>
                    </li>
                     <li>
                        <strong>California Blackberry:</strong>
                        <a href="https://www.adkinsarboretum.org/programs_events/ipp/common-blackberry.html" target="_blank" rel="noopener noreferrer">Adkins Arboretum</a> |
                        <a href="https://www.fs.usda.gov/database/feis/plants/shrub/ruburs/all.html" target="_blank" rel="noopener noreferrer">USDA FS</a> |
                        <a href="https://www.ballonafriends.org/plants" target="_blank" rel="noopener noreferrer">Friends of Ballona Wetlands</a>
                    </li>
                     <li>
                        <strong>Elderberry:</strong>
                        <a href="https://www.sandiego.edu/kumeyaay-garden/plant.php?ID=6" target="_blank" rel="noopener noreferrer">USD Kumeyaay Garden</a> |
                        <a href="https://hiddensandiego.com/elderberry.php" target="_blank" rel="noopener noreferrer">Hidden San Diego</a>
                    </li>
                     <li>
                        <strong>Acorns:</strong>
                        <a href="https://www.visitcalifornia.com/experience/acorns-and-native-american-culture/" target="_blank" rel="noopener noreferrer">Visit California</a> |
                        <a href="https://hiddensandiego.com/wild-acorn-cookies.php" target="_blank" rel="noopener noreferrer">Hidden San Diego</a> |
                        <a href="https://hearstmuseum.berkeley.edu/exhibit/exploring-california-indigenous-food-practices-traditional-acorn-mush/" target="_blank" rel="noopener noreferrer">Hearst Museum</a>
                    </li>
                </ul>
                 <h3>Disclaimer</h3>
                 <p>This guide is for informational purposes only. Foraging can be dangerous. Always consult with a local expert and be 100% certain of identification before consuming any wild plant. Respect local regulations and private property.</p>
            </div>
        </div>

        <div class="start-screen" id="startScreen">
            <div class="start-screen-text">CLICK TO START</div>
        </div>

        <div class="log-on-screen" id="logOnScreen">
            <div class="log-on-text" id="logOnText">SYSTEM BOOT</div>
            <div class="log-on-bar" id="logOnBar">
                <div class="log-on-progress" id="logOnProgress"></div>
            </div>
        </div>

        <div class="pokedex-leds">
            <div class="led red"></div>
            <div class="led yellow"></div>
            <div class="led green"></div>
        </div>
        <button class="info-button" id="infoButton" title="About/References">
            <i class="fas fa-info"></i>
        </button>

        <div class="pokedex-screen" id="pokedexScreen"> <div class="plant-list" id="plantList">
                </div>
            <div class="plant-detail" id="plantDetail">
                </div>
        </div>
        <div class="pokedex-controls">
             <button class="nav-button" id="prevButton" disabled>
                 <i class="fas fa-caret-left"></i> Prev
             </button>
             <button class="nav-button" id="nextButton" disabled>
                 Next <i class="fas fa-caret-right"></i>
             </button>
         </div>
         <div class="dev-credits">Foraging Pokedex v1.0 | Dev: Justin Moran</div>
    </div>

    <script>
        // --- Sound Synthesis (Tone.js) ---
        const buttonTapSynth = new Tone.PluckSynth({ attackNoise: 0.5, dampening: 2500, resonance: 0.5, release: 0.1, volume: -12 }).toDestination();
        const selectSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }, volume: -22 }).toDestination();
        const confirmSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.25 }, volume: -20 }).toDestination();

        // Boot Loop Synth Setup
        const bootDelay = new Tone.FeedbackDelay("8n", 0.5).toDestination();
        const bootFilter = new Tone.Filter(1500, "lowpass").connect(bootDelay);
        const bootLoopSynth = new Tone.Synth({
            oscillator: { type: 'sine' },
            envelope: { attack: 0.5, decay: 0.08, sustain: 0.05, release: 0.15 },
            volume: -50
        }).connect(bootFilter);

        // Volume LFO for Boot Loop
        const bootVolumeLFO = new Tone.LFO({ frequency: "8n", min: -38, max: -20, amplitude: 1, type: "sine" }).connect(bootLoopSynth.volume);

        // Boot Loop Sequence (New Arpeggio)
        const bootSequence = new Tone.Sequence((time, note) => {
            bootLoopSynth.triggerAttackRelease(note, "16n", time);
        }, ["C4", "G4", "C5", "G5", "C6", "G5", "C5", "G4"], "8n");

        // Boot Finished Synth (PolySynth C4+G4, louder)
        const bootFinishReverb = new Tone.Reverb(0.5).toDestination();
        const bootFinishSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'sine' },
            envelope: { attack: 0.01, decay: 0.3, sustain: 0.2, release: 0.4 },
            volume: -6 // Louder
        }).connect(bootFinishReverb);


        // --- Pixel Art SVGs ---
        const pixelArt = { /* ... SVGs remain the same ... */ };
        // --- Plant Data (Defined globally) ---
        const plants = [
             { number: "001", name: "California Buckwheat", image: "images/calibuckwheat.jpg", pixelArt: pixelArt.buckwheat, description: "California Buckwheat (Eriogonum fasciculatum) is a dominant shrub in coastal sage scrub. Its small flowers provide nectar for pollinators.", identification: "Woody shrub, narrow leaves, clusters of small white to pinkish flowers that dry to reddish-brown.", nativeAmericanUse: "Various tribes used it. Tea from leaves/stems/roots. Seeds eaten raw or used in porridges/baked items. Tongva used leaf tea; ground roots for headaches/stomach issues. Used for diarrhea, wounds. Zuni applied root poultice to cuts.", stats: { availability: "Abundant", season: "Summer/Fall", edibility: "Requires Prep", difficulty: "Medium" } },
             { number: "002", name: "Lemonade Berry", image: "images/lemonade berry.jpeg", pixelArt: pixelArt.lemonade, description: "Lemonade Berry (Rhus integrifolia) is an evergreen shrub/small tree. Berries have a sticky, tart coating used to make a lemonade-like drink.", identification: "Leathery, toothed leaves, pinkish-white flower clusters, flattened reddish berries.", nativeAmericanUse: "'Iipay (Kumeyaay): Berry drink for constipation; fruit syrup for stomach aches/coughs; seed tea for fever; bark tea for babies. Berries eaten fresh or flavored water. Seeds ground, leached, boiled into mush.", stats: { availability: "Common", season: "Spring/Summer", edibility: "Good", difficulty: "Easy" } },
             { number: "003", name: "California Coffeeberry", image: "images/ca_coffeeberry.jpg", pixelArt: pixelArt.coffeeberry, description: "California Coffeeberry (Frangula californica) is a common evergreen shrub. Berries (red to black when ripe) are edible but often bland/bitter. Mild laxative effect.", identification: "Oval, glossy leaves, small greenish flowers, berry-like drupes ripening to black.", nativeAmericanUse: "Kumeyaay: Stored, boiled bark used as physic or for poison oak treatment. Berry infusion taken as tonic. Ohlone: Inner bark used as laxative and for poison oak rashes.", stats: { availability: "Common", season: "Summer/Fall", edibility: "Caution", difficulty: "Medium" } },
             { number: "004", name: "Toyon", image: "images/toyon.jpg", pixelArt: pixelArt.toyon, description: "Toyon (Heteromeles arbutifolia), or California Holly, is an evergreen shrub. Bright red berries in winter are edible *after cooking* (contain cyanide precursors raw).", identification: "Leathery, toothed leaves, clusters of small white flowers, bright red pomes (berries).", nativeAmericanUse: "Resource for Chumash, Tongva, Luiseno, Kumeyaay, Cahuilla. Kumeyaay: Pounded leaf pulp to wash sores. Fruit eaten after preparation. Bark/leaf infusions washed wounds. Tongva (ashuwet): Roasted/cooked/boiled berries for cider/jellies.", stats: { availability: "Common", season: "Winter", edibility: "Caution", difficulty: "Medium" } },
             { number: "005", name: "Prickly Pear", image: "images/Prickly-pear.webp", pixelArt: pixelArt.pricklypear, description: "Prickly Pear (Opuntia species) cacti have edible pads (nopales) and fruits (tunas). Both need careful spine/glochid removal.", identification: "Fleshy, flattened pads with spines, yellow/red flowers, oval/pear-shaped fruits (tunas).", nativeAmericanUse: "Staple food/medicine. Fruits eaten fresh, made into candy, gum, mush, syrup, juice, jelly, or dried. Young pads (nopales) boiled as vegetable. Pads applied to wounds, rheumatism, mumps, swelling. Spines used as needles. Juice dyed textiles.", stats: { availability: "Common", season: "Summer (Fruit)", edibility: "Requires Prep", difficulty: "Hard" } },
             { number: "006", name: "Miner's Lettuce", image: "images/miners-lettuce.jpg", pixelArt: pixelArt.minerslettuce, description: "Miner's Lettuce (Claytonia perfoliata) is a succulent annual herb. Leaves/stems edible raw or cooked (good Vitamin C source). Named for miners using it against scurvy.", identification: "Basal leaves, stem leaves fused into a cup around the stem, small white/pinkish flowers emerging from cup center.", nativeAmericanUse: "Introduced to miners by Native Americans for Vitamin C. Leaves, stems, flowers, roots edible raw or cooked.", stats: { availability: "Common", season: "Spring", edibility: "High", difficulty: "Easy" } },
             { number: "007", name: "California Blackberry", image: "images/CaliforniaBlackberry.jpg", pixelArt: pixelArt.blackberry, description: "California Blackberry (Rubus ursinus) is a native trailing vine with thorns. Berries are smaller but often sweeter than cultivated ones.", identification: "Trailing thorny stems, compound leaves (usually 3 leaflets), white/pinkish flowers, small black aggregate fruits.", nativeAmericanUse: "Berries eaten fresh, ground for pemmican, or dried. Used medicinally for dysentery, diarrhea, coughs, sore throat, wounds. Root/leaf infusion for diarrhea, rheumatism, colds, coughs. Root wash for sore eyes. Stem decoction for UTIs. Canes used for basketry.", stats: { availability: "Common", season: "Summer", edibility: "High", difficulty: "Medium" } },
             { number: "008", name: "Elderberry", image: "images/elderberry.jpg", pixelArt: pixelArt.elderberry, description: "California Elderberry (Sambucus nigra ssp. caerulea) is a large shrub/small tree. Dark berries edible *when cooked* (jams, jellies, syrups); raw berries can be toxic.", identification: "Pinnately compound leaves, large flat-topped clusters of creamy white flowers, clusters of dark purple/black berries with white bloom.", nativeAmericanUse: "Kumeyaay: Bark healed wounds/sores. Berries dried, boiled, eaten (boiling removes toxins). Flowers boiled, rubbed on aching joints. Dried blossom tea for fever. Bark for skirts, branches for ceremonies. Cahuilla also used berries/twigs.", stats: { availability: "Common", season: "Summer/Fall", edibility: "Caution", difficulty: "Medium" } },
             { number: "009", name: "Acorns", image: "images/acorns.jpeg", pixelArt: pixelArt.acorns, description: "Acorns from Oak species (Quercus spp.) were a California staple. Not edible raw (high tannins); require extensive leaching.", identification: "Varies by oak species; recognizable nuts with a cap.", nativeAmericanUse: "Essential food (Kumeyaay, etc.). Highly nutritious but require leaching. Major community activity. Ground into flour, leached with water, made into mush (wewish/nupa), soups, breads. Tanoak acorns used medicinally (coughs). Oak stands managed via cultural burning.", stats: { availability: "Abundant", season: "Fall", edibility: "Requires Prep", difficulty: "Hard" } }
        ];
        console.log("Global plants array defined:", plants);

        // DOM Elements
        const startScreen = document.getElementById('startScreen');
        const logOnScreen = document.getElementById('logOnScreen');
        const logOnText = document.getElementById('logOnText');
        const logOnBar = document.getElementById('logOnBar');
        const logOnProgress = document.getElementById('logOnProgress');
        const pokedexScreen = document.getElementById('pokedexScreen');
        const plantListDiv = document.getElementById('plantList');
        const plantDetailDiv = document.getElementById('plantDetail');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const infoButton = document.getElementById('infoButton');
        const infoModalOverlay = document.getElementById('infoModalOverlay');
        const closeModalButton = document.getElementById('closeModalButton');
        let selectedPlantItem = null;
        let currentPlantIndex = 0;
        let isSoundEnabled = false;
        let isBooting = true;
        let bootSoundsScheduled = false;
        let bootFinishSoundScheduled = false;

        // --- Functions ---

        /** Play a sound using Tone.js */
        function playSound(type, note = null, time = Tone.now()) {
             if (!isSoundEnabled && type !== 'bootFinish') return;
            try {
                 if (type === 'buttonTap') {
                    buttonTapSynth.triggerAttack("C5", time);
                } else if (type === 'select') {
                    selectSynth.triggerAttackRelease('D5', '16n', time + 0.01);
                } else if (type === 'confirm') {
                     confirmSynth.triggerAttackRelease("F5", "16n", time);
                     confirmSynth.triggerAttackRelease("Bb5", "16n", time + 0.1);
                 } else if (type === 'bootFinish') {
                     if (bootFinishSoundScheduled) {
                        console.log("Playing boot finish sound at time:", time.toFixed(2));
                        bootFinishSynth.triggerAttackRelease(["C4", "G4"], "4n", time);
                        bootFinishSoundScheduled = false;
                     } else {
                         console.log("Skipped playing boot finish sound - not scheduled.");
                     }
                 }
            } catch (error) { console.error("Tone.js error:", error); }
        }

        /** Enable sound - Called only AFTER first user click */
        async function enableSoundAndStartAudio() {
            if (isSoundEnabled) return;
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    console.log("Audio Context Started by user interaction.");
                    isSoundEnabled = true;
                    if (Tone.Transport.state !== 'started') {
                        Tone.Transport.bpm.value = 92;
                        Tone.Transport.start();
                        console.log("Tone Transport Started");
                    }
                    scheduleBootSounds();
                } catch (e) {
                    console.error("Error starting Tone.js:", e);
                    isSoundEnabled = false;
                }
            } else {
                 isSoundEnabled = true;
                 if (Tone.Transport.state !== 'started') {
                     Tone.Transport.bpm.value = 92;
                     Tone.Transport.start();
                     console.log("Tone Transport Started (already running context)");
                 }
                 scheduleBootSounds();
            }
        }


        /** Renders the list of plants */
        function renderPlantList() {
            plantListDiv.innerHTML = '';
            if (!plants || plants.length === 0) {
                 console.error("renderPlantList: Global plants array is empty or undefined.");
                 plantListDiv.innerHTML = '<p style="text-align: center; color: var(--pokedex-text-secondary); padding: 20px;">No plants in list.</p>';
                 return;
            }
            console.log(`renderPlantList: Rendering ${plants.length} plants.`);
            plants.forEach((plant, index) => {
                const plantItem = document.createElement('div');
                plantItem.classList.add('plant-item');
                plantItem.setAttribute('data-index', index);
                plantItem.innerHTML = `
                    <div class="icon-container">
                        ${plant.pixelArt || '<svg viewBox="0 0 16 16" class="pixel-art-icon"><rect width="16" height="16" fill="#bdbdbd"/></svg>'}
                    </div>
                    <div class="plant-info">
                        <span class="plant-number">#${plant.number}</span>
                        <span class="plant-name">${plant.name}</span>
                    </div>`;
                plantItem.addEventListener('click', () => {
                    playSound('select');
                    navigateToPlant(index);
                });
                plantListDiv.appendChild(plantItem);
            });
        }


        /** Visually highlights the selected plant item */
        function selectPlantItem(index) {
             const newIndex = parseInt(index, 10);
             const listItems = plantListDiv.querySelectorAll('.plant-item');
             if (isNaN(newIndex) || newIndex < 0 || !plants || newIndex >= plants.length) {
                 console.error(`selectPlantItem: Invalid index ${index}.`);
                 return;
             }
             if (!listItems || listItems.length === 0 || newIndex >= listItems.length) {
                 console.warn(`selectPlantItem: List items not ready or index out of bounds for index ${newIndex}.`);
                 return;
             }

             if (selectedPlantItem) selectedPlantItem.classList.remove('selected');

             const newItem = listItems[newIndex];
             if (newItem) {
                 newItem.classList.add('selected');
                 selectedPlantItem = newItem;
                 const listRect = plantListDiv.getBoundingClientRect();
                 const itemRect = newItem.getBoundingClientRect();
                 if (itemRect.top < listRect.top || itemRect.bottom > listRect.bottom) {
                    newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 }
             } else {
                 console.error(`selectPlantItem: Could not find list item for index ${newIndex}.`);
                 selectedPlantItem = null;
             }
             // Enable/disable buttons based on index
             prevButton.disabled = (newIndex === 0);
             nextButton.disabled = (newIndex === plants.length - 1);
         }


        /** Creates HTML for the stats section */
        function createStatsHtml(stats) { /* ... (same as before) ... */ }
        function createStatsHtml(stats) {
            if (!stats) return '';
            let statsHtml = '<div class="stats-section"><h3>Stats</h3><div class="stats-grid">';
            const statLabels = { availability: "Availability", season: "Season", edibility: "Edibility", difficulty: "Harvest Difficulty" };
            for (const key in statLabels) {
                if (stats[key]) {
                    statsHtml += `<div class="stat-item"><span class="label">${statLabels[key]}</span><span class="value" data-value="${stats[key]}">${stats[key]}</span></div>`;
                }
            }
            statsHtml += '</div></div>';
            return statsHtml;
        }

        /** Function to generate detail HTML */
        function generateDetailHtml(plantIndex) {
            if (plantIndex < 0 || !plants || plantIndex >= plants.length) {
                console.error(`generateDetailHtml: Invalid plant index ${plantIndex}`);
                return '<p>Error: Invalid plant data.</p>';
            }
            const plant = plants[plantIndex];
             if (!plant) {
                 console.error(`generateDetailHtml: Plant data is null/undefined for index ${plantIndex}`);
                 return '<p>Error: Plant data missing.</p>';
             }
            const fallbackImage = 'https://placehold.co/400x300/f1f3f5/212529?text=Image+Not+Found';
            return `
                <div class="plant-header"><span>${plant.name || 'N/A'}</span><span class="number">#${plant.number || '???'}</span></div>
                <div class="plant-core-info">
                    <div class="plant-image-section"><img src="${plant.image}" alt="${plant.name || 'Plant'}" onerror="this.onerror=null; this.src='${fallbackImage}';"></div>
                    <div class="plant-attributes">${createStatsHtml(plant.stats)}</div>
                </div>
                ${plant.description ? `<div class="attribute-section"><h3>Description</h3><p>${plant.description}</p></div>` : ''}
                ${plant.identification ? `<div class="attribute-section"><h3>Identification</h3><p>${plant.identification}</p></div>` : ''}
                ${plant.nativeAmericanUse ? `<div class="attribute-section"><h3>Traditional Native Use</h3><p>${plant.nativeAmericanUse}</p></div>` : ''}
                <div class="disclaimer"><strong>Disclaimer:</strong> This guide is for informational purposes only... Respect local regulations and private property.</div>`;
        }


        /** Displays the details of a selected plant with transition */
        function displayPlantDetail(index) {
             if (index < 0 || !plants || index >= plants.length ) return;

             const plant = plants[index];
             currentPlantIndex = index;

             pokedexScreen.classList.add('loading');

             const contentWrapper = document.createElement('div');
             contentWrapper.classList.add('plant-detail-content');
             contentWrapper.style.opacity = '0'; // Start faded out for transition
             contentWrapper.style.transform = 'translateX(15px)';
             contentWrapper.innerHTML = generateDetailHtml(index); // Generate HTML based on index

             const existingContent = plantDetailDiv.querySelector('.plant-detail-content');

             const replaceContent = () => {
                 plantDetailDiv.innerHTML = ''; // Clear previous content
                 plantDetailDiv.appendChild(contentWrapper);
                 plantDetailDiv.scrollTop = 0;
                 requestAnimationFrame(() => {
                     setTimeout(() => {
                         pokedexScreen.classList.remove('loading');
                         playSound('confirm'); // Play confirm sound on subsequent loads
                         contentWrapper.style.opacity = '1';
                         contentWrapper.style.transform = 'translateX(0)';
                     }, 10);
                 });
             };

             if (existingContent) { // Only apply fade-out logic if content already exists
                 existingContent.style.opacity = '0';
                 existingContent.style.transform = 'translateX(-15px)';
                 existingContent.addEventListener('transitionend', replaceContent, { once: true });
             } else {
                  // Fallback if no content exists (shouldn't happen after initial load fix)
                  console.error("displayPlantDetail called without existing content.");
                  replaceContent();
             }
         }


        /** Handles navigation to a specific plant index */
        function navigateToPlant(index) {
            if (isBooting) return;
            if (index >= 0 && index < plants.length && index !== currentPlantIndex) {
                displayPlantDetail(index); // Pass index only
                selectPlantItem(index); // Pass index only
            } else if (index < 0 || index >= plants.length) {
                 // Optional: Play 'bump' sound
            }
        }

        /** Sets up event listeners for global navigation buttons */
        function setupGlobalNavButtons() {
            prevButton.addEventListener('click', () => {
                 if (isBooting) return;
                 navigateToPlant(currentPlantIndex - 1);
             });
            nextButton.addEventListener('click', () => {
                 if (isBooting) return;
                 navigateToPlant(currentPlantIndex + 1);
             });

             [prevButton, nextButton].forEach(button => {
                 button.addEventListener('mousedown', () => {
                     if(!button.disabled && !isBooting) {
                         playSound('buttonTap'); // Play tap sound on press
                     }
                 });
             });
             // Info Button Listener
             infoButton.addEventListener('click', () => {
                 playSound('buttonTap'); // Use same tap sound
                 infoModalOverlay.classList.add('visible');
             });
             closeModalButton.addEventListener('click', () => {
                 playSound('buttonTap');
                 infoModalOverlay.classList.remove('visible');
             });
             // Optional: Close modal if clicking outside the content
             infoModalOverlay.addEventListener('click', (event) => {
                 if (event.target === infoModalOverlay) { // Check if click was on overlay itself
                     playSound('buttonTap');
                     infoModalOverlay.classList.remove('visible');
                 }
             });
        }

        /** Function to schedule boot sounds */
        const scheduleBootSounds = () => {
             if (bootSoundsScheduled || Tone.context.state !== 'running') {
                 console.log("Skipping boot sound scheduling (already scheduled or context not ready).");
                 return;
             }
             bootSoundsScheduled = true;

             const startTime = Tone.now() + 0.2;
             const bootAnimDuration = 3.5;
             const bootFinishPause = 1.2;
             const bootLoopEndTime = startTime + bootAnimDuration;
             const bootFinishSoundTime = bootLoopEndTime + bootFinishPause;

             console.log(`Scheduling boot sounds: Start=${startTime.toFixed(2)}, Loop End=${bootLoopEndTime.toFixed(2)}, Finish Sound=${bootFinishSoundTime.toFixed(2)}`);

             if (Tone.Transport.state !== 'started') {
                 Tone.Transport.bpm.value = 92;
                 Tone.Transport.start(startTime);
             }
             bootVolumeLFO.start(startTime);
             bootSequence.start(startTime).stop(bootLoopEndTime);

             // Schedule finish sound using a flag
             Tone.Transport.scheduleOnce(time => {
                 bootFinishSoundScheduled = true; // Set flag
                 playSound('bootFinish', null, time);
             }, bootFinishSoundTime);
         };

        /** ** UPDATED Initialization Sequence ** */
        function initializePokedex() {
            console.log("Initializing Pokedex...");
             // Pre-process plant data (using global plants array)
             plants.forEach(p => {
                if (!p.identification && p.description) { const m = p.description.match(/Identification: (.*)/); if (m && m[1]) p.identification = m[1]; }
             });

             // Clear placeholders immediately
             plantDetailDiv.innerHTML = '';
             plantListDiv.innerHTML = '';

             // Setup Start Screen Listener
             startScreen.addEventListener('click', async () => {
                 console.log("Start screen clicked.");
                 startScreen.classList.add('hidden'); // Hide start screen

                 // Try to enable sound immediately on click
                 try {
                     await enableSoundAndStartAudio(); // Wait for audio context
                 } catch (error) {
                     console.error("Could not start audio:", error);
                 }

                 // Show and animate log-on screen
                 logOnScreen.classList.add('visible');
                 logOnText.classList.add('animate');
                 logOnBar.classList.add('animate');
                 logOnProgress.classList.add('animate');

                 // Set timeout for final UI setup AFTER boot animation
                 const totalBootDuration = 3.5 + 1.2 + 0.5; // Match visual + pause + buffer
                 setTimeout(() => {
                     console.log("Boot timeout finished. Setting up UI.");
                     isBooting = false;
                     logOnScreen.classList.add('hidden'); // Hide log-on screen

                     // ** Render list and setup buttons **
                     renderPlantList(); // Uses global plants
                     setupGlobalNavButtons(); // Uses global plants implicitly

                     // ** Load initial plant data directly **
                     console.log("Attempting to load initial plant data. Global plants array length:", plants ? plants.length : 'undefined');
                     if (plants && plants.length > 0) {
                         currentPlantIndex = 0;
                         const firstPlant = plants[0];
                         console.log("First plant data:", firstPlant);
                         if (firstPlant) {
                             const initialHtml = generateDetailHtml(0); // Get HTML for index 0
                             const initialContentWrapper = document.createElement('div');
                             initialContentWrapper.classList.add('plant-detail-content');
                             initialContentWrapper.innerHTML = initialHtml;
                             // ** Direct Insertion **
                             plantDetailDiv.innerHTML = ''; // Clear just in case
                             plantDetailDiv.appendChild(initialContentWrapper);
                             // Make it visible immediately
                             requestAnimationFrame(() => {
                                initialContentWrapper.style.opacity = '1';
                             });
                             console.log("Initial plant data displayed.");
                             selectPlantItem(0); // Select the first item
                         } else {
                              console.error("Could not get first plant data (plants[0] is undefined).");
                              plantDetailDiv.innerHTML = '<div class="plant-detail-content" style="opacity:1;"><p>Error loading initial plant.</p></div>';
                         }
                     } else {
                         console.log("No plant data found inside timeout.");
                         plantDetailDiv.innerHTML = '<div class="plant-detail-content" style="opacity:1;"><p style="text-align: center; color: var(--pokedex-text-secondary); margin-top: 40px;">No plant data loaded.</p></div>';
                         plantListDiv.innerHTML = '<p style="text-align: center; color: var(--pokedex-text-secondary); padding: 20px;">No plants in list.</p>';
                         prevButton.disabled = true;
                         nextButton.disabled = true;
                     }

                     logOnScreen.addEventListener('transitionend', () => {
                        if (logOnScreen) logOnScreen.remove();
                     }, { once: true });

                 }, totalBootDuration * 1000);

             }, { once: true }); // Only allow starting once
        }

        document.addEventListener('DOMContentLoaded', initializePokedex);
    </script>

</body>
</html>
